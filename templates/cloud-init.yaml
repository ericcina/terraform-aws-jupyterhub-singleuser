#cloud-config

final_message: "The system is finally up, after $UPTIME seconds"

# We add Conda using RPM/APT
yum_repos:
  conda:
    name: Conda
    baseurl: https://repo.anaconda.com/pkgs/misc/rpmrepo/conda
    enabled: true
    gpgcheck: true
    gpgkey: https://repo.anaconda.com/pkgs/misc/gpgkeys/anaconda.asc

packages:
  - conda
#package_upgrade: true

users:
  - default
  - name: ${user}
    lock_passwd: true
    ssh_redirect_user: true

write_files:
  - path: /etc/supervisor/supervisord.conf
    content: |
      # Auto-Generated by terraform-aws-jupyterhub-singleuser
      [unix_http_server]
      file=/tmp/supervisord.sock

      [supervisord]
      logfile=%(here)s/supervisord.log
      user=${user}

      [program:jupyterlab]
      command=conda-exec -- jlab jupyter-labhub --ip ${ip} --port ${port} --notebook-dir ~
      startsecs=10
      redirect_stderr=true
      stdout_logfile=%(home)s/jupyterlab.log

runcmd:
  - ln -s /opt/conda/etc/profile.d/conda.{csh,sh} /etc/profile.d/
  - |
    source /etc/profile.d/conda.sh
    conda create -n jlab -qy conda-forge::conda-exec anaconda-client nb_conda_kernels jupyterlab jupyterhub
    conda-exec -- supervisor supervisord
